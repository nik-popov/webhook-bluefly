<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bluefly Sync</title>
<style>
  :root {
    --bg: #ffffff;
    --surface: #ffffff;
    --surface2: #f8f9fa;
    --border: #e5e7eb;
    --text: #111827;
    --text-muted: #6b7280;
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --success: #16a34a;
    --success-bg: #f0fdf4;
    --error: #dc2626;
    --error-bg: #fef2f2;
    --warning: #d97706;
    --warning-bg: #fffbeb;
    --gray-badge: #6b7280;
    --gray-badge-bg: #f3f4f6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #ffffff;
    color: var(--text);
    line-height: 1.5;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: #ffffff;
    border-bottom: 1px solid var(--border);
  }
  .header h1 { font-size: 18px; font-weight: 600; color: #111827; }
  .header .subtitle { font-size: 13px; color: var(--text-muted); }
  .tabs {
    display: flex;
    background: #ffffff;
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    gap: 0;
  }
  .tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    transition: all .15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
  .tab-content { display: none; padding: 24px; }
  .tab-content.active { display: block; }
  .inner-tab-bar { display:flex; border-bottom:1px solid var(--border); margin:16px 0 0; gap:0; }
  .inner-tab-btn { padding:9px 18px; background:none; border:none; border-bottom:2px solid transparent; margin-bottom:-1px; color:var(--text-muted); font-size:13px; cursor:pointer; transition:all .15s; white-space:nowrap; }
  .inner-tab-btn:hover { color:var(--text); }
  .inner-tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); font-weight:500; }
  .inner-tab-panel { padding-top:16px; }
  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .card {
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .card .value.success { color: var(--success); }
  .card .value.error { color: var(--error); }
  .card .value.warning { color: var(--warning); }
  .btn {
    padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all .15s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: var(--primary-hover); }
  .btn-success { background: var(--success); color: #fff; }
  .btn-danger { background: var(--error); color: #fff; }
  .btn-outline { background: #ffffff; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { border-color: var(--text-muted); background: #f9fafb; }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-warning { background: var(--warning); color: #fff; }
  .btn-warning:hover { background: #b45309; }
  .toolbar {
    display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .toolbar input, .toolbar select {
    padding: 8px 12px; background: #ffffff; border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 13px;
  }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: var(--primary); }
  .section-heading {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px; margin-top: 8px;
  }
  .section-heading h3 {
    font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;
  }
  .section-heading .count {
    font-size: 12px; font-weight: 500; color: var(--text-muted);
    background: #f3f4f6; padding: 2px 8px; border-radius: 10px;
  }
  .table-wrap {
    overflow-x: auto; background: #ffffff; border: 1px solid var(--border);
    border-radius: 8px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  table { width: 100%; border-collapse: collapse; }
  th {
    text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    background: #f9fafb; white-space: nowrap;
  }
  td { padding: 10px 16px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: #f9fafb; }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 10px;
    font-size: 11px; font-weight: 600; text-transform: uppercase;
  }
  .badge-success { background: var(--success-bg); color: var(--success); }
  .badge-error { background: var(--error-bg); color: var(--error); }
  .badge-gray { background: var(--gray-badge-bg); color: var(--gray-badge); }
  .badge-warning { background: var(--warning-bg); color: var(--warning); }
  .badge-info { background: #eff6ff; color: var(--primary); }
  .prod-img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #f3f4f6; }
  .prod-img-placeholder {
    width: 40px; height: 40px; border-radius: 6px; background: #f3f4f6;
    display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 16px;
  }
  .settings-group {
    background: #ffffff; border: 1px solid var(--border); border-radius: 8px;
    padding: 24px; margin-bottom: 16px; max-width: 700px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .settings-group h3 { font-size: 15px; margin-bottom: 16px; }
  .form-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .form-row label { font-size: 13px; min-width: 180px; color: var(--text-muted); }
  .form-row input, .form-row select {
    padding: 8px 12px; background: #ffffff; border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 14px;
  }
  .form-row input[type="number"] { width: 120px; }
  .form-row input:focus, .form-row select:focus { outline: none; border-color: var(--primary); }
  .preview-text { font-size: 13px; color: var(--text-muted); margin-top: 8px; }
  .info-row { display: flex; gap: 8px; font-size: 13px; margin-bottom: 6px; }
  .info-label { color: var(--text-muted); min-width: 140px; }
  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500;
    animation: slideIn 0.3s ease; max-width: 400px; box-shadow: 0 4px 16px rgba(0,0,0,0.10);
  }
  .toast-success { background: #16a34a; color: #fff; }
  .toast-error { background: #dc2626; color: #fff; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
  .progress-bar { background: #f3f4f6; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
  .progress-bar .fill { height: 100%; background: var(--primary); transition: width 0.3s; }
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,0.08); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .stream-log {
    background: #f9fafb; border: 1px solid var(--border); border-radius: 8px; padding: 16px;
    max-height: 300px; overflow-y: auto; font-family: 'Menlo','Consolas',monospace;
    font-size: 12px; line-height: 1.8; display: none;
  }
  .stream-log .log-line { padding: 2px 0; }
  .stream-log .log-success { color: var(--success); }
  .stream-log .log-error { color: var(--error); }
  .stream-log .log-info { color: var(--primary); }
  .pagination {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-top: 1px solid var(--border); background: #f9fafb;
    font-size: 13px; color: var(--text-muted);
  }
  .pagination .page-info { font-weight: 500; }
  .pagination .page-controls { display: flex; gap: 4px; align-items: center; }
  .pagination .page-controls button {
    padding: 4px 10px; border: 1px solid var(--border); background: #fff;
    border-radius: 4px; font-size: 12px; cursor: pointer; color: var(--text);
  }
  .pagination .page-controls button:hover:not(:disabled) { background: #f3f4f6; }
  .pagination .page-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
  .pagination .page-controls button.active { background: var(--primary); color: #fff; border-color: var(--primary); }
  .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
  .empty-state .empty-text { font-size: 14px; }
  .loading-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
  .loading-state .spinner { width: 24px; height: 24px; margin-bottom: 12px; }
  .loading-state .loading-text { font-size: 14px; }
  .error-banner {
    background: var(--error-bg); border: 1px solid #fecaca; border-radius: 8px;
    padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: var(--error);
    display: none;
  }
  .error-banner.visible { display: block; }
  /* Checkbox toggle */
  .toggle-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .toggle-row label { font-size: 13px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 8px; }
  .toggle-row input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--primary); }
  .toggle-row .hint { font-size: 11px; color: var(--text-muted); }
  /* Source badge */
  .source-badge {
    display: inline-block; padding: 1px 6px; border-radius: 4px;
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
  }
  .source-badge.metafield { background: #dbeafe; color: #1d4ed8; }
  .source-badge.product { background: #d1fae5; color: #065f46; }
  .source-badge.tag_parse { background: #fef3c7; color: #92400e; }
  .source-badge.option { background: #e0e7ff; color: #3730a3; }
  .source-badge.variant { background: #fce7f3; color: #9d174d; }
  .source-badge.default { background: #f3f4f6; color: #374151; }
  .source-badge.auto { background: #f0fdf4; color: #166534; }
  .link-external { color: var(--primary); text-decoration: none; font-size: 13px; font-weight: 500; }
  .link-external:hover { text-decoration: underline; }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>Bluefly Sync App</h1>
    <div class="subtitle">Shopify to Bluefly Product API</div>
  </div>
  <div style="font-size:12px; color:var(--text-muted);" id="header-info"></div>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="home">Dashboard</button>
  <button class="tab-btn" data-tab="products">Products</button>
  <button class="tab-btn" data-tab="events">Events</button>
  <button class="tab-btn" data-tab="mapping">Field Mapping</button>
  <button class="tab-btn" data-tab="catalog">Catalog</button>
  <button class="tab-btn" data-tab="settings">Settings</button>
</div>

<!-- ============ TAB: Dashboard (Home) ============ -->
<div id="tab-home" class="tab-content active">
  <div id="home-error" class="error-banner"></div>
  <div class="cards">
    <div class="card">
      <div class="label">Unread Events</div>
      <div class="value warning" id="stat-unread"><span class="spinner"></span></div>
    </div>
    <div class="card">
      <div class="label">Errors</div>
      <div class="value error" id="stat-errors"><span class="spinner"></span></div>
    </div>
    <div class="card">
      <div class="label">Eligible Products</div>
      <div class="value" id="stat-eligible"><span class="spinner"></span></div>
    </div>
    <div class="card">
      <div class="label">Published (Bluefly)</div>
      <div class="value success" id="stat-synced"><span class="spinner"></span></div>
    </div>
    <div class="card">
      <div class="label">Matched in Catalog</div>
      <div class="value success" id="stat-matched"><span class="spinner"></span></div>
    </div>
    <div class="card">
      <div class="label">Bluefly Catalog</div>
      <div class="value" id="stat-catalog" style="color:var(--primary)"><span class="spinner"></span></div>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn btn-primary" onclick="processEvents()">Process Pending Events</button>
    <button class="btn btn-outline" onclick="loadDashboard()">Refresh Stats</button>
  </div>
  <div id="home-log" class="stream-log"></div>
</div>

<!-- ============ TAB: Products ============ -->
<div id="tab-products" class="tab-content">
  <div id="products-error" class="error-banner"></div>

  <div id="bulk-progress" style="display:none;">
    <div class="progress-bar"><div class="fill" id="bulk-fill" style="width:0%"></div></div>
    <div id="bulk-status" style="font-size:13px; color:var(--text-muted); margin-bottom:12px;"></div>
  </div>
  <div id="bulk-log" class="stream-log"></div>

  <!-- Inner tabs: Published / Not Published -->
  <div class="inner-tab-bar">
    <button class="inner-tab-btn active" data-panel="published" onclick="switchProductTab('published')">
      Published to Bluefly&nbsp;<span class="count" id="published-count">0</span>
      <span style="font-weight:400;font-size:12px;color:var(--text-muted);margin-left:6px;">·&nbsp;<span id="catalog-matched-count">0</span> live</span>
    </button>
    <button class="inner-tab-btn" data-panel="unpublished" onclick="switchProductTab('unpublished')">
      Not Published&nbsp;<span class="count" id="unpublished-count">0</span>
    </button>
  </div>

  <!-- Published panel -->
  <div id="products-panel-published" class="inner-tab-panel">
    <div class="toolbar" style="margin-bottom:12px;">
      <input type="text" id="pub-search" placeholder="Search published…" style="min-width:240px;" oninput="filterPublished()">
      <button class="btn btn-primary" onclick="loadProducts()">Refresh</button>
      <span id="pub-count-label" style="font-size:13px;color:var(--text-muted);"></span>
    </div>
    <div id="catalog-debug" style="display:none;margin-bottom:12px;">
      <details>
        <summary style="font-size:12px;color:var(--text-muted);cursor:pointer;">Catalog API raw response (debug — no products returned)</summary>
        <pre id="catalog-debug-body" style="font-size:11px;background:#f3f4f6;padding:12px;border-radius:6px;margin-top:8px;overflow:auto;max-height:200px;white-space:pre-wrap;"></pre>
      </details>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th></th><th>Title</th><th>Vendor</th><th>Category</th>
            <th>Variants</th><th>Bluefly Price</th><th>Qty</th><th>Push Status</th><th>Live Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="published-tbody"></tbody>
      </table>
      <div class="pagination" id="published-pagination"></div>
    </div>
  </div>

  <!-- Not Published panel -->
  <div id="products-panel-unpublished" class="inner-tab-panel" style="display:none;">
    <div class="toolbar" style="margin-bottom:12px;">
      <input type="text" id="unpub-search" placeholder="Search not published…" style="min-width:240px;" oninput="filterUnpublished()">
      <button class="btn btn-success" id="bulk-push-btn" onclick="bulkPush()">Push All Unpushed</button>
      <button class="btn btn-primary" onclick="loadProducts()">Refresh</button>
      <span id="unpub-count-label" style="font-size:13px;color:var(--text-muted);"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th></th><th>Title</th><th>Vendor</th><th>Category</th>
            <th>Variants</th><th>Bluefly Price</th><th>Qty</th><th>Eligible</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="unpublished-tbody"></tbody>
      </table>
      <div class="pagination" id="unpublished-pagination"></div>
    </div>
  </div>
</div>

<!-- ============ TAB: Events ============ -->
<div id="tab-events" class="tab-content">
  <div id="events-error" class="error-banner"></div>
  <div class="toolbar">
    <input type="date" id="event-date" onchange="loadEvents()">
    <select id="event-status" onchange="loadEvents()">
      <option value="">All Statuses</option>
      <option value="unread">Unread</option>
      <option value="processing">Processing</option>
      <option value="processed">Processed</option>
      <option value="error">Error</option>
    </select>
    <select id="event-type" onchange="loadEvents()">
      <option value="">All Types</option>
      <option value="webhook_shopify">Webhook</option>
      <option value="sql_db">SQL DB</option>
    </select>
    <button class="btn btn-primary" onclick="processEvents()">Scan &amp; Process</button>
    <button class="btn btn-outline" onclick="loadEvents()">Refresh</button>
    <span id="event-count" style="font-size:13px; color:var(--text-muted);"></span>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Time</th><th>Type</th><th>Topic</th><th>Product ID</th><th>Status</th></tr>
      </thead>
      <tbody id="events-tbody"></tbody>
    </table>
    <div class="pagination" id="events-pagination"></div>
  </div>
</div>

<!-- ============ TAB: Field Mapping ============ -->
<div id="tab-mapping" class="tab-content">
  <div id="mapping-error" class="error-banner"></div>

  <div class="toolbar" style="margin-bottom:12px">
    <a href="http://3.150.206.227/bluefly/conversion" target="_blank" class="link-external">Open BlueFly Size Conversion Tool &rarr;</a>
    <button class="btn btn-sm" onclick="loadFieldMapping()">Refresh</button>
  </div>

  <div class="settings-group">
    <h3>Product-Level Fields</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Bluefly Field</th>
          <th>Source</th>
          <th>Shopify Source</th>
          <th>Default Value</th>
          <th>Description</th>
          <th>Required</th>
        </tr>
      </thead>
      <tbody id="product-fields-tbody"></tbody>
    </table>
  </div>

  <div class="settings-group" style="margin-top:20px">
    <h3>Variant-Level Fields</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Bluefly Field</th>
          <th>Source</th>
          <th>Shopify Source</th>
          <th>Default Value</th>
          <th>Description</th>
          <th>Required</th>
        </tr>
      </thead>
      <tbody id="variant-fields-tbody"></tbody>
    </table>
  </div>

  <div class="settings-group" style="margin-top:20px">
    <h3>Default Values</h3>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">These defaults are used when a field cannot be derived from the product data.</p>
    <div class="form-row">
      <label>Return Policy</label>
      <select id="default-is-returnable">
        <option>Returnable</option>
        <option>Not Returnable</option>
      </select>
    </div>
    <div class="form-row">
      <label>Product Condition</label>
      <select id="default-product-condition">
        <option>New</option>
        <option>Used</option>
        <option>Refurbished</option>
      </select>
    </div>
    <div class="form-row">
      <label>Listing Status</label>
      <select id="default-listing-status">
        <option>Live</option>
        <option>NotLive</option>
      </select>
    </div>
    <div class="form-row">
      <label>Color Standard (fallback)</label>
      <select id="default-color-standard">
        <option>No color</option>
        <option>Beige</option>
        <option>Black</option>
        <option>Blue</option>
        <option>Brown</option>
        <option>Gold</option>
        <option>Green</option>
        <option>Grey</option>
        <option>Multi</option>
        <option>Off White</option>
        <option>Orange</option>
        <option>Pink</option>
        <option>Purple</option>
        <option>Red</option>
        <option>Silver</option>
        <option>White</option>
        <option>Yellow</option>
      </select>
    </div>
    <div class="form-row" style="font-size:12px;color:var(--text-muted)">
      Used when a product's color can't be matched to a standard value (e.g. "Chartreuse" → falls back to this default).
    </div>
    <div class="form-row">
      <button class="btn btn-primary" onclick="saveFieldDefaults()">Save Defaults</button>
    </div>
  </div>

  <div class="settings-group" style="margin-top:24px">
    <h3>Bluefly Field Catalog</h3>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">All fields available on the Bluefly platform. Filter by category ID to see which fields apply to that category.</p>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
      <input id="catalog-search" type="text" placeholder="Search by field name…" style="flex:1;min-width:160px" oninput="renderCatalogTable()">
      <input id="catalog-category" type="text" placeholder="Category ID (e.g. 634)" style="width:190px" oninput="renderCatalogTable()">
      <select id="catalog-level" onchange="renderCatalogTable()">
        <option value="">All levels</option>
        <option value="Group">Product-level</option>
        <option value="Buyable">Variant-level</option>
      </select>
      <select id="catalog-importance" onchange="renderCatalogTable()">
        <option value="">All importance</option>
        <option value="Required">Required</option>
        <option value="ConditionallyRequired">Conditional</option>
      </select>
    </div>
    <div id="catalog-count" style="font-size:12px;color:var(--text-muted);margin-bottom:6px"></div>
    <div style="overflow-x:auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Category / Group</th>
            <th>Display Name</th>
            <th>Field Name</th>
            <th>Level</th>
            <th>Importance</th>
            <th>Type</th>
            <th>Allowed Values</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="catalog-tbody"></tbody>
      </table>
    </div>
    <div id="catalog-error" class="error-banner" style="display:none"></div>
  </div>
</div>

<!-- ============ TAB: Settings ============ -->
<div id="tab-settings" class="tab-content">
  <div id="settings-error" class="error-banner"></div>

  <div class="settings-group">
    <h3>Price Adjustment</h3>
    <div class="form-row">
      <label>Adjustment (%)</label>
      <input type="number" id="price-adj" step="0.1" value="0">
      <button class="btn btn-primary btn-sm" onclick="saveSettings()">Save</button>
    </div>
    <div class="preview-text" id="price-preview">
      A $100.00 Shopify price becomes <strong>$100.00</strong> on Bluefly
    </div>
  </div>

  <div class="settings-group">
    <h3>Eligibility Criteria</h3>
    <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">
      Products must meet these criteria to appear in the "Not Published but Eligible" table and be pushed to Bluefly.
    </p>
    <div class="toggle-row">
      <label>
        <input type="checkbox" id="elig-category" checked>
        Require Bluefly Category
        <span class="hint">(custom.bluefly_category metafield must be set)</span>
      </label>
    </div>
    <div class="toggle-row">
      <label>
        <input type="checkbox" id="elig-quantity" checked>
        Require Quantity &gt; 0
        <span class="hint">(total inventory across variants must be positive)</span>
      </label>
    </div>
    <div class="toggle-row">
      <label>
        <input type="checkbox" id="elig-images" checked>
        Require Product Images
        <span class="hint">(at least one product image must exist)</span>
      </label>
    </div>
    <button class="btn btn-primary btn-sm" onclick="saveEligibility()" style="margin-top:8px;">Save Eligibility</button>
  </div>

  <div class="settings-group">
    <h3>System Info</h3>
    <div class="info-row"><span class="info-label">Shopify Store:</span> <span id="info-store">--</span></div>
    <div class="info-row"><span class="info-label">Bluefly Seller ID:</span> <span id="info-seller">--</span></div>
    <div class="info-row"><span class="info-label">Webhook Log Dir:</span> <span id="info-logdir">--</span></div>
    <div class="info-row"><span class="info-label">Pipeline Log Dir:</span> <span id="info-pipedir">--</span></div>
  </div>
</div>

<!-- ============ TAB: Catalog ============ -->
<div id="tab-catalog" class="tab-content">
  <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
    <h2 style="margin:0">Bluefly Catalog</h2>
    <span id="catalog-match-summary" style="color:var(--text-muted);font-size:0.875rem"></span>
  </div>
  <div class="toolbar" style="margin-bottom:12px;">
    <input type="text" id="catalog-search" placeholder="Search catalog…" style="min-width:240px;" oninput="filterCatalog()">
    <select id="catalog-status-filter" onchange="filterCatalog()">
      <option value="">All Statuses</option>
      <option value="Live">Live</option>
      <option value="NotLive">Not Live</option>
    </select>
    <select id="catalog-match-filter" onchange="filterCatalog()">
      <option value="">All</option>
      <option value="matched">Matched</option>
      <option value="orphan">Orphan</option>
    </select>
    <span id="catalog-count-label" style="font-size:13px;color:var(--text-muted);"></span>
  </div>
  <div style="overflow-x:auto">
    <table class="products-table" id="catalog-table">
      <thead>
        <tr>
          <th>Name</th><th>Brand</th><th>SKU</th>
          <th>Variants</th><th>Qty</th><th>Listing Status</th><th>Shopify Match</th>
        </tr>
      </thead>
      <tbody id="catalog-tbody"></tbody>
    </table>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
// -----------------------------------------------------------------------
// Core API helper
// -----------------------------------------------------------------------
const API_BASE = window.location.origin;

async function apiFetch(path, options = {}) {
  const url = API_BASE + path;
  const opts = {
    cache: 'no-store',
    headers: {'Accept': 'application/json'},
    ...options,
  };
  let res;
  try {
    res = await fetch(url, opts);
  } catch (networkErr) {
    throw new Error('Network error: could not reach server. Make sure you are accessing http://localhost:5000');
  }
  const contentType = res.headers.get('content-type') || '';
  if (!contentType.includes('json')) {
    const text = await res.text();
    throw new Error(`Server returned non-JSON (HTTP ${res.status}). Check that you are on http://localhost:5000`);
  }
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function apiPost(path, body) {
  return apiFetch(path, {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
    body: JSON.stringify(body),
  });
}

// -----------------------------------------------------------------------
// Inner product sub-tabs
// -----------------------------------------------------------------------
function switchProductTab(name) {
  document.querySelectorAll('.inner-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.panel === name));
  document.getElementById('products-panel-published').style.display = name === 'published' ? '' : 'none';
  document.getElementById('products-panel-unpublished').style.display = name === 'unpublished' ? '' : 'none';
}

// -----------------------------------------------------------------------
// Tab switching
// -----------------------------------------------------------------------
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');

    const tab = btn.dataset.tab;
    if (tab === 'home') loadDashboard();
    if (tab === 'products') loadProducts();
    if (tab === 'events') loadEvents();
    if (tab === 'mapping') loadFieldMapping();
    if (tab === 'catalog') loadCatalogTab();
    if (tab === 'settings') loadSettings();
  });
});

// -----------------------------------------------------------------------
// Toast / error helpers
// -----------------------------------------------------------------------
function toast(msg, type = 'success') {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 5000);
}

function showError(bannerId, msg) {
  const el = document.getElementById(bannerId);
  el.textContent = msg;
  el.classList.add('visible');
}

function hideError(bannerId) {
  const el = document.getElementById(bannerId);
  el.textContent = '';
  el.classList.remove('visible');
}

// -----------------------------------------------------------------------
// Loading / empty / error state helpers
// -----------------------------------------------------------------------
function loadingHTML(cols) {
  return `<tr><td colspan="${cols}"><div class="loading-state"><span class="spinner"></span><div class="loading-text">Loading...</div></div></td></tr>`;
}
function emptyHTML(cols, msg) {
  return `<tr><td colspan="${cols}"><div class="empty-state"><div class="empty-text">${msg}</div></div></td></tr>`;
}

// -----------------------------------------------------------------------
// Pagination engine
// -----------------------------------------------------------------------
const PAGE_SIZE = 25;
const _pageState = {};

function paginate(items, tableKey) {
  if (!_pageState[tableKey]) _pageState[tableKey] = { page: 1 };
  const state = _pageState[tableKey];
  const total = items.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if (state.page > totalPages) state.page = totalPages;
  const start = (state.page - 1) * PAGE_SIZE;
  const pageItems = items.slice(start, start + PAGE_SIZE);
  return { items: pageItems, page: state.page, totalPages, total, start };
}

function renderPagination(containerId, tableKey, total, page, totalPages, onPageChange) {
  const container = document.getElementById(containerId);
  if (total <= PAGE_SIZE) { container.innerHTML = ''; return; }
  const start = (page - 1) * PAGE_SIZE + 1;
  const end = Math.min(page * PAGE_SIZE, total);
  let pageButtons = '';
  const maxButtons = 5;
  let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  if (endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);
  for (let i = startPage; i <= endPage; i++) {
    pageButtons += `<button class="${i === page ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
  }
  container.innerHTML = `
    <div class="page-info">Showing ${start}-${end} of ${total}</div>
    <div class="page-controls">
      <button ${page <= 1 ? 'disabled' : ''} onclick="${onPageChange}(${page-1})">Prev</button>
      ${pageButtons}
      <button ${page >= totalPages ? 'disabled' : ''} onclick="${onPageChange}(${page+1})">Next</button>
    </div>
  `;
}

// -----------------------------------------------------------------------
// Dashboard / Home
// -----------------------------------------------------------------------
let _allProducts = [];
let _priceAdj = 0;
let _eligibility = {};
let _catalogProducts = [];
let _shopifySkuSet = new Set();

async function loadDashboard() {
  hideError('home-error');
  document.getElementById('stat-unread').innerHTML = '<span class="spinner"></span>';
  document.getElementById('stat-errors').innerHTML = '<span class="spinner"></span>';
  document.getElementById('stat-eligible').innerHTML = '<span class="spinner"></span>';
  document.getElementById('stat-synced').innerHTML = '<span class="spinner"></span>';
  document.getElementById('stat-matched').innerHTML = '<span class="spinner"></span>';
  document.getElementById('stat-catalog').innerHTML = '<span class="spinner"></span>';

  try {
    const [prodData, eventData, jobData, catalogData] = await Promise.all([
      apiFetch('/api/products'),
      apiFetch('/api/events?status=unread'),
      apiFetch('/api/pipeline/jobs'),
      apiFetch('/api/bluefly/catalog').catch(() => ({products:[], total:0})),
    ]);

    const products = prodData.products || [];
    const unread = eventData.events || [];
    const jobs = jobData.jobs || [];
    const catalog = catalogData.products || [];

    const synced = products.filter(p => p.sync_status === 'pushed').length;
    const errors = jobs.filter(j => j.status === 'error').length;

    // Build SKU set from catalog for fast lookup
    const catalogSkus = new Set();
    for (const cp of catalog) {
      if (cp.seller_sku) catalogSkus.add(cp.seller_sku);
      for (const vsku of (cp.variant_skus || [])) {
        if (vsku) catalogSkus.add(vsku);
      }
    }
    const matched = products.filter(p => p.sync_status === 'pushed' && p.first_sku && catalogSkus.has(p.first_sku)).length;

    document.getElementById('stat-unread').textContent = unread.length;
    document.getElementById('stat-errors').textContent = errors;
    document.getElementById('stat-eligible').textContent = products.length;
    document.getElementById('stat-synced').textContent = synced;
    document.getElementById('stat-matched').textContent = matched;
    document.getElementById('stat-catalog').textContent = catalog.length;
  } catch (e) {
    showError('home-error', 'Failed to load dashboard: ' + e.message);
    document.getElementById('stat-unread').textContent = '--';
    document.getElementById('stat-errors').textContent = '--';
    document.getElementById('stat-eligible').textContent = '--';
    document.getElementById('stat-synced').textContent = '--';
    document.getElementById('stat-matched').textContent = '--';
    document.getElementById('stat-catalog').textContent = '--';
  }
}

// -----------------------------------------------------------------------
// Products (Published + Live Catalog merged / Not Published)
// -----------------------------------------------------------------------
let _allPublishedProducts = [];
let _allUnpublishedProducts = [];
let _publishedProducts = [];
let _unpublishedProducts = [];
let _catalogBySku = {};
let _shopifyStore = '';

async function loadProducts() {
  hideError('products-error');
  document.getElementById('published-tbody').innerHTML = loadingHTML(10);
  document.getElementById('unpublished-tbody').innerHTML = loadingHTML(9);
  document.getElementById('pub-search').value = '';
  document.getElementById('unpub-search').value = '';
  _pageState['published'] = { page: 1 };
  _pageState['unpublished'] = { page: 1 };

  try {
    const [data, catalogData] = await Promise.all([
      apiFetch('/api/products'),
      apiFetch('/api/bluefly/catalog').catch(() => ({products:[], total:0})),
    ]);
    if (data.error) throw new Error(data.error);

    _allProducts = data.products || [];
    _priceAdj = data.price_adjustment_pct || 0;
    _eligibility = data.eligibility || {};
    _shopifyStore = data.store || '';
    _catalogProducts = catalogData.products || [];

    // Build Shopify SKU set for catalog match status
    _shopifySkuSet = new Set(_allProducts.map(p => p.first_sku).filter(Boolean));

    // Show raw catalog response when empty (debug)
    if (catalogData.total === 0 && catalogData.raw_body) {
      document.getElementById('catalog-debug').style.display = '';
      document.getElementById('catalog-debug-body').textContent = catalogData.raw_body;
    } else {
      document.getElementById('catalog-debug').style.display = 'none';
    }

    splitAndRender(_allProducts);
    renderCatalogTable(_shopifySkuSet);
  } catch (e) {
    showError('products-error', e.message);
    document.getElementById('published-tbody').innerHTML = emptyHTML(10, 'Could not load products');
    document.getElementById('unpublished-tbody').innerHTML = '';
  }
}

function _matchesSearch(p, q) {
  return p.title.toLowerCase().includes(q) ||
    p.vendor.toLowerCase().includes(q) ||
    (p.first_sku || '').toLowerCase().includes(q) ||
    String(p.id).includes(q);
}

function filterPublished() {
  const q = document.getElementById('pub-search').value.toLowerCase();
  _publishedProducts = q ? _allPublishedProducts.filter(p => _matchesSearch(p, q)) : _allPublishedProducts.slice();
  _pageState['published'] = { page: 1 };
  _updatePublishedCounts();
  renderPublishedPage(1);
}

function filterUnpublished() {
  const q = document.getElementById('unpub-search').value.toLowerCase();
  _unpublishedProducts = q ? _allUnpublishedProducts.filter(p => _matchesSearch(p, q)) : _allUnpublishedProducts.slice();
  _pageState['unpublished'] = { page: 1 };
  _updateUnpublishedCounts();
  renderUnpublishedPage(1);
}

function _updatePublishedCounts() {
  const adj = _priceAdj ? ` (${_priceAdj > 0 ? '+' : ''}${_priceAdj}%)` : '';
  document.getElementById('published-count').textContent = _allPublishedProducts.length;
  const matchedCount = _allPublishedProducts.filter(p => p.first_sku && _catalogBySku[p.first_sku]).length;
  document.getElementById('catalog-matched-count').textContent = matchedCount;
  const showing = _publishedProducts.length !== _allPublishedProducts.length
    ? `${_publishedProducts.length} of ${_allPublishedProducts.length}${adj}`
    : `${_allPublishedProducts.length}${adj}`;
  document.getElementById('pub-count-label').textContent = showing + ' products';
}

function _updateUnpublishedCounts() {
  const adj = _priceAdj ? ` (${_priceAdj > 0 ? '+' : ''}${_priceAdj}%)` : '';
  document.getElementById('unpublished-count').textContent = _allUnpublishedProducts.length;
  const showing = _unpublishedProducts.length !== _allUnpublishedProducts.length
    ? `${_unpublishedProducts.length} of ${_allUnpublishedProducts.length}${adj}`
    : `${_allUnpublishedProducts.length}${adj}`;
  document.getElementById('unpub-count-label').textContent = showing + ' products';
}

function splitAndRender(products) {
  // Build catalog lookup indexed by product-level AND variant-level SKUs
  // so that p.first_sku (variant SKU) reliably hits the right catalog entry.
  _catalogBySku = {};
  for (const cp of _catalogProducts) {
    if (cp.seller_sku) _catalogBySku[cp.seller_sku] = cp;
    for (const vsku of (cp.variant_skus || [])) {
      if (vsku) _catalogBySku[vsku] = cp;
    }
  }

  // Trust the push log as the source of truth for Published status.
  // The catalog is used for the live-status badge only (see renderProductTable).
  _allPublishedProducts = products.filter(p => p.sync_status === 'pushed');
  _allUnpublishedProducts = products.filter(p => !_allPublishedProducts.includes(p));
  _publishedProducts = _allPublishedProducts.slice();
  _unpublishedProducts = _allUnpublishedProducts.slice();

  _updatePublishedCounts();
  _updateUnpublishedCounts();

  renderPublishedPage(_pageState['published'] ? _pageState['published'].page : 1);
  renderUnpublishedPage(_pageState['unpublished'] ? _pageState['unpublished'].page : 1);
}

function renderCatalogTable(shopifySkuSet) {
  const tbody = document.getElementById('catalog-tbody');
  if (!tbody) return;

  const statusFilter = document.getElementById('catalog-status-filter') ? document.getElementById('catalog-status-filter').value : '';
  const matchFilter = document.getElementById('catalog-match-filter') ? document.getElementById('catalog-match-filter').value : '';
  const searchQuery = document.getElementById('catalog-search') ? document.getElementById('catalog-search').value.toLowerCase() : '';

  let matched = 0;
  let totalMatched = 0;
  const rows = [];

  for (const cp of _catalogProducts) {
    const isMatched = (cp.variant_skus || []).some(s => shopifySkuSet.has(s))
                   || shopifySkuSet.has(cp.seller_sku);
    if (isMatched) totalMatched++;

    // Apply status filter
    if (statusFilter && (cp.listing_status || '').toLowerCase() !== statusFilter.toLowerCase()) continue;

    // Apply match filter
    if (matchFilter === 'matched' && !isMatched) continue;
    if (matchFilter === 'orphan' && isMatched) continue;

    // Apply search filter
    if (searchQuery) {
      const hay = [cp.name, cp.brand, cp.seller_sku, ...(cp.variant_skus || [])].join(' ').toLowerCase();
      if (!hay.includes(searchQuery)) continue;
    }

    if (isMatched) matched++;
    const badge = isMatched
      ? '<span class="badge badge-success">Matched</span>'
      : '<span class="badge badge-gray">Orphan</span>';
    rows.push(`<tr>
      <td>${cp.name || '\u2014'}</td>
      <td>${cp.brand || '\u2014'}</td>
      <td><code>${cp.seller_sku}</code></td>
      <td>${cp.buyable_count ?? '\u2014'}</td>
      <td>${cp.total_quantity ?? '\u2014'}</td>
      <td>${cp.listing_status || '\u2014'}</td>
      <td>${badge}</td>
    </tr>`);
  }

  tbody.innerHTML = rows.length
    ? rows.join('')
    : '<tr><td colspan="7" style="text-align:center;color:var(--text-muted)">No catalog items</td></tr>';
  const summary = document.getElementById('catalog-match-summary');
  if (summary) summary.textContent = `${totalMatched} matched \u00b7 ${_catalogProducts.length - totalMatched} orphan`;
  const countLabel = document.getElementById('catalog-count-label');
  if (countLabel) {
    const isFiltered = statusFilter || matchFilter || searchQuery;
    countLabel.textContent = isFiltered
      ? `Showing ${rows.length} of ${_catalogProducts.length} products`
      : `${_catalogProducts.length} products`;
  }
}

function filterCatalog() {
  renderCatalogTable(_shopifySkuSet);
}

async function loadCatalogTab() {
  const tbody = document.getElementById('catalog-tbody');
  tbody.innerHTML = loadingHTML(7);
  try {
    const [prodData, catalogData] = await Promise.all([
      apiFetch('/api/products'),
      apiFetch('/api/bluefly/catalog').catch(() => ({products:[], total:0})),
    ]);
    _allProducts = prodData.products || [];
    _catalogProducts = catalogData.products || [];
    _shopifySkuSet = new Set(_allProducts.map(p => p.first_sku).filter(Boolean));
    renderCatalogTable(_shopifySkuSet);
  } catch (e) {
    tbody.innerHTML = emptyHTML(7, 'Could not load catalog: ' + e.message);
  }
}

function renderPublishedPage(page) {
  if (!_pageState['published']) _pageState['published'] = {};
  _pageState['published'].page = page;
  const paged = paginate(_publishedProducts, 'published');
  renderProductTable('published-tbody', paged.items, true,
    _publishedProducts.length === 0 ? 'No products published to Bluefly yet' : '');
  renderPagination('published-pagination', 'published', paged.total, paged.page, paged.totalPages, 'renderPublishedPage');
}

function renderUnpublishedPage(page) {
  if (!_pageState['unpublished']) _pageState['unpublished'] = {};
  _pageState['unpublished'].page = page;
  const paged = paginate(_unpublishedProducts, 'unpublished');
  renderUnpublishedTable('unpublished-tbody', paged.items,
    _unpublishedProducts.length === 0 ? 'All eligible products are published' : '');
  renderPagination('unpublished-pagination', 'unpublished', paged.total, paged.page, paged.totalPages, 'renderUnpublishedPage');
}

function renderProductTable(tbodyId, products, isPublished, emptyMsg) {
  const tbody = document.getElementById(tbodyId);
  if (!products.length) {
    tbody.innerHTML = emptyHTML(isPublished ? 10 : 9, emptyMsg || 'No products');
    return;
  }
  tbody.innerHTML = products.map(p => {
    const img = p.image_url
      ? `<img src="${p.image_url}&width=80" class="prod-img" loading="lazy" onerror="this.outerHTML='<div class=prod-img-placeholder>?</div>'">`
      : '<div class="prod-img-placeholder">?</div>';

    let statusBadge;
    if (p.sync_status === 'pushed') statusBadge = '<span class="badge badge-success">Pushed</span>';
    else if (p.sync_status === 'error') statusBadge = '<span class="badge badge-error">Error</span>';
    else if (p.sync_status === 'skipped') statusBadge = '<span class="badge badge-warning">Skipped</span>';
    else statusBadge = '<span class="badge badge-gray">Never</span>';

    // Live catalog status via SKU join
    let liveStatusCell = '';
    if (isPublished) {
      const catData = p.first_sku ? _catalogBySku[p.first_sku] : null;
      if (catData) {
        const ls = (catData.listing_status || '').toLowerCase();
        if (ls === 'live') liveStatusCell = '<span class="badge badge-success">Live</span>';
        else if (ls === 'notlive') liveStatusCell = '<span class="badge badge-gray">NotLive</span>';
        else if (ls === 'mixed') liveStatusCell = '<span class="badge badge-warning">Mixed</span>';
        else liveStatusCell = `<span class="badge badge-gray">${esc(catData.listing_status)}</span>`;
      } else {
        liveStatusCell = '<span style="color:var(--text-muted)">—</span>';
      }
    }

    let actions;
    if (isPublished) {
      const catEntry = p.first_sku ? _catalogBySku[p.first_sku] : null;
      const shopifyQty = p.total_quantity ?? 0;
      const catalogQty = catEntry ? (catEntry.total_quantity ?? null) : null;
      const qtyMismatch = catalogQty !== null && shopifyQty !== catalogQty;
      const syncBtnClass = qtyMismatch ? 'btn-warning' : 'btn-outline';
      const syncTitle = qtyMismatch
        ? `Qty mismatch: Shopify=${shopifyQty}, Bluefly=${catalogQty}. Click to sync.`
        : 'Sync qty+price to Bluefly';
      actions = `<button class="btn btn-primary btn-sm" onclick="pushProduct(${p.id}, this)" title="Re-push">Re-push</button>
                 <button class="btn ${syncBtnClass} btn-sm" onclick="syncQtyPrice(${p.id}, this)" title="${syncTitle}">Sync</button>`;
    } else {
      actions = `<button class="btn btn-primary btn-sm" onclick="pushProduct(${p.id}, this)" title="Push to Bluefly">Push</button>`;
    }

    let priceDisplay = '-';
    if (p.adjusted_price != null) {
      priceDisplay = `<strong>$${parseFloat(p.adjusted_price).toFixed(2)}</strong>`;
      if (p.first_price && _priceAdj) {
        priceDisplay += `<br><span style="font-size:10px;color:var(--text-muted);text-decoration:line-through;">$${parseFloat(p.first_price).toFixed(2)}</span>`;
      }
    } else if (p.first_price) {
      priceDisplay = '$' + parseFloat(p.first_price).toFixed(2);
    }

    const liveCol = isPublished ? `<td>${liveStatusCell}</td>` : '';
    return `<tr>
      <td>${img}</td>
      <td><a href="https://${_shopifyStore}/admin/products/${p.id}" target="_blank" style="text-decoration:none;color:inherit;"><strong>${esc(p.title)}</strong></a><br><span style="font-size:11px;color:var(--text-muted)">ID: ${p.id}</span></td>
      <td>${esc(p.vendor)}</td>
      <td>${esc(p.bluefly_category || '-')}</td>
      <td>${p.variant_count}</td>
      <td>${priceDisplay}</td>
      <td>${p.total_quantity}</td>
      <td>${statusBadge}</td>
      ${liveCol}
      <td style="white-space:nowrap;">${actions}</td>
    </tr>`;
  }).join('');
}

function renderUnpublishedTable(tbodyId, products, emptyMsg) {
  const tbody = document.getElementById(tbodyId);
  if (!products.length) {
    tbody.innerHTML = emptyHTML(9, emptyMsg || 'No products');
    return;
  }
  tbody.innerHTML = products.map(p => {
    const img = p.image_url
      ? `<img src="${p.image_url}&width=80" class="prod-img" loading="lazy" onerror="this.outerHTML='<div class=prod-img-placeholder>?</div>'">`
      : '<div class="prod-img-placeholder">?</div>';

    let priceDisplay = '-';
    if (p.adjusted_price != null) {
      priceDisplay = `<strong>$${parseFloat(p.adjusted_price).toFixed(2)}</strong>`;
      if (p.first_price && _priceAdj) {
        priceDisplay += `<br><span style="font-size:10px;color:var(--text-muted);text-decoration:line-through;">$${parseFloat(p.first_price).toFixed(2)}</span>`;
      }
    } else if (p.first_price) {
      priceDisplay = '$' + parseFloat(p.first_price).toFixed(2);
    }

    // Eligibility indicator
    const issues = [];
    if (!p.has_images) issues.push('No images');
    if (!p.has_quantity) issues.push('Qty = 0');
    const eligBadge = p.push_eligible
      ? '<span class="badge badge-success">Ready</span>'
      : `<span class="badge badge-warning" title="${esc(issues.join(', '))}">${esc(issues.join(', ') || 'Ineligible')}</span>`;

    const pushBtn = p.push_eligible
      ? `<button class="btn btn-primary btn-sm" onclick="pushProduct(${p.id}, this)">Push</button>`
      : `<button class="btn btn-outline btn-sm" disabled title="${esc(issues.join(', '))}">Ineligible</button>`;

    return `<tr>
      <td>${img}</td>
      <td><a href="https://${_shopifyStore}/admin/products/${p.id}" target="_blank" style="text-decoration:none;color:inherit;"><strong>${esc(p.title)}</strong></a><br><span style="font-size:11px;color:var(--text-muted)">ID: ${p.id}</span></td>
      <td>${esc(p.vendor)}</td>
      <td>${esc(p.bluefly_category || '-')}</td>
      <td>${p.variant_count}</td>
      <td>${priceDisplay}</td>
      <td>${p.total_quantity}</td>
      <td>${eligBadge}</td>
      <td style="white-space:nowrap;">${pushBtn}</td>
    </tr>`;
  }).join('');
}

async function pushProduct(productId, btn) {
  btn.disabled = true;
  const origText = btn.textContent;
  btn.innerHTML = '<span class="spinner"></span>';
  try {
    const data = await apiPost('/api/products/push', {product_id: productId});
    if (data.success) {
      toast('Pushed: ' + data.product_title);
      const pidx = _allUnpublishedProducts.findIndex(p => p.id === productId);
      if (pidx >= 0) {
        const moved = _allUnpublishedProducts.splice(pidx, 1)[0];
        moved.sync_status = 'pushed';
        _allPublishedProducts.unshift(moved);
        _publishedProducts = _allPublishedProducts.slice();
        _unpublishedProducts = _allUnpublishedProducts.slice();
        _updatePublishedCounts();
        _updateUnpublishedCounts();
        renderPublishedPage(_pageState['published'] ? _pageState['published'].page : 1);
        renderUnpublishedPage(_pageState['unpublished'] ? _pageState['unpublished'].page : 1);
      }
    } else {
      toast(data.error || 'Push failed', 'error');
    }
  } catch (e) {
    toast('Push error: ' + e.message, 'error');
  }
  btn.disabled = false;
  btn.textContent = origText;
}

async function syncQtyPrice(productId, btn) {
  btn.disabled = true;
  const origClass = btn.className;
  btn.innerHTML = '<span class="spinner"></span>';
  try {
    const data = await apiPost('/api/products/sync-qty-price', {product_id: productId});
    if (data.success) {
      toast('Synced: ' + data.product_title);
      renderPublishedPage(_pageState['published'] ? _pageState['published'].page : 1);
    } else {
      toast(data.error || 'Sync failed', 'error');
    }
  } catch (e) {
    toast('Sync error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.className = origClass;
    btn.textContent = 'Sync';
  }
}

async function bulkPush() {
  const btn = document.getElementById('bulk-push-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Pushing...';
  const progressEl = document.getElementById('bulk-progress');
  const fillEl = document.getElementById('bulk-fill');
  const statusEl = document.getElementById('bulk-status');
  const logEl = document.getElementById('bulk-log');
  progressEl.style.display = 'block';
  logEl.style.display = 'block';
  logEl.innerHTML = '';
  fillEl.style.width = '0%';

  try {
    const res = await fetch(API_BASE + '/api/products/push-bulk', {method: 'POST', cache: 'no-store'});
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, {stream: true});
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.trim()) continue;
        try {
          const msg = JSON.parse(line);
          if (msg.type === 'start') {
            statusEl.textContent = `Pushing 0 / ${msg.total}...`;
          } else if (msg.type === 'success') {
            const pct = Math.round((msg.index / msg.total) * 100);
            fillEl.style.width = pct + '%';
            statusEl.textContent = `Pushing ${msg.index} / ${msg.total}...`;
            logEl.innerHTML += `<div class="log-line log-success">OK ${esc(msg.title)} (${msg.product_id})</div>`;
          } else if (msg.type === 'error') {
            logEl.innerHTML += `<div class="log-line log-error">ERR ${msg.product_id}: ${esc(msg.error)}</div>`;
          } else if (msg.type === 'skip') {
            logEl.innerHTML += `<div class="log-line log-info">SKIP ${msg.product_id}: ${esc(msg.reason)}</div>`;
          } else if (msg.type === 'complete') {
            fillEl.style.width = '100%';
            statusEl.textContent = `Complete: ${msg.success} pushed, ${msg.errors} errors`;
            toast(`Bulk push complete: ${msg.success} pushed, ${msg.errors} errors`);
          }
          logEl.scrollTop = logEl.scrollHeight;
        } catch (e) {}
      }
    }
  } catch (e) {
    toast('Bulk push error: ' + e.message, 'error');
  }
  btn.disabled = false;
  btn.innerHTML = 'Push All Unpushed';
  loadProducts();
}

// -----------------------------------------------------------------------
// Events (with pagination)
// -----------------------------------------------------------------------
let _allEvents = [];

async function loadEvents() {
  hideError('events-error');
  const tbody = document.getElementById('events-tbody');
  tbody.innerHTML = loadingHTML(5);
  document.getElementById('events-pagination').innerHTML = '';
  _pageState['events'] = { page: 1 };

  const date = document.getElementById('event-date').value;
  const status = document.getElementById('event-status').value;
  const eventType = document.getElementById('event-type').value;
  let path = '/api/events?';
  if (date) path += 'date=' + date + '&';
  if (status) path += 'status=' + status + '&';
  if (eventType) path += 'type=' + eventType;

  try {
    const data = await apiFetch(path);
    if (data.error) throw new Error(data.error);
    _allEvents = data.events || [];
    document.getElementById('event-count').textContent = _allEvents.length + ' events';
    renderEventsPage(1);
  } catch (e) {
    showError('events-error', e.message);
    tbody.innerHTML = emptyHTML(5, 'Could not load events');
  }
}

function renderEventsPage(page) {
  _pageState['events'] = { page: page };
  const paged = paginate(_allEvents, 'events');
  const tbody = document.getElementById('events-tbody');

  if (!paged.items.length) {
    tbody.innerHTML = emptyHTML(5, 'No events found');
    document.getElementById('events-pagination').innerHTML = '';
    return;
  }

  tbody.innerHTML = paged.items.map(ev => {
    let badge;
    if (ev.status === 'processed') badge = '<span class="badge badge-success">Processed</span>';
    else if (ev.status === 'error') badge = '<span class="badge badge-error">Error</span>';
    else if (ev.status === 'unread') badge = '<span class="badge badge-warning">Unread</span>';
    else if (ev.status === 'processing') badge = '<span class="badge badge-info">Processing</span>';
    else badge = `<span class="badge badge-gray">${esc(ev.status)}</span>`;
    const typeBadge = ev.type === 'sql_db'
      ? '<span class="badge badge-info">SQL DB</span>'
      : '<span class="badge badge-gray">Webhook</span>';
    const topicExtra = ev.type === 'sql_db' && ev.category_id
      ? `<br><span style="font-size:10px;color:var(--text-muted)">cat:${esc(String(ev.category_id))} &nbsp;fields:${ev.field_count ?? 0}</span>`
      : '';
    const time = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : '-';
    return `<tr>
      <td>${time}</td>
      <td>${typeBadge}</td>
      <td><code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:12px;">${esc(ev.topic)}</code>${topicExtra}</td>
      <td>${ev.product_id || '-'}</td>
      <td>${badge}</td>
    </tr>`;
  }).join('');

  renderPagination('events-pagination', 'events', paged.total, paged.page, paged.totalPages, 'renderEventsPage');
}

async function processEvents() {
  try {
    const data = await apiPost('/api/events/process', {});
    if (data.error) {
      toast(data.error, 'error');
    } else {
      toast(data.message);
      setTimeout(() => { loadDashboard(); loadEvents(); }, 2000);
    }
  } catch (e) {
    toast('Process error: ' + e.message, 'error');
  }
}

// -----------------------------------------------------------------------
// Settings
// -----------------------------------------------------------------------
async function loadSettings() {
  hideError('settings-error');
  try {
    const data = await apiFetch('/api/settings');
    document.getElementById('price-adj').value = data.price_adjustment_pct || 0;
    document.getElementById('info-store').textContent = data.store || '-';
    document.getElementById('info-seller').textContent = data.seller_id || '-';
    document.getElementById('info-logdir').textContent = data.log_dir || '-';
    document.getElementById('info-pipedir').textContent = data.pipeline_log_dir || '-';

    // Eligibility checkboxes
    const elig = data.eligibility || {};
    document.getElementById('elig-category').checked = elig.require_category !== false;
    document.getElementById('elig-quantity').checked = elig.require_quantity !== false;
    document.getElementById('elig-images').checked = elig.require_images !== false;

    updatePricePreview();
  } catch (e) {
    showError('settings-error', 'Failed to load settings: ' + e.message);
  }
}

async function saveSettings() {
  const adj = parseFloat(document.getElementById('price-adj').value) || 0;
  try {
    const data = await apiPost('/api/settings', {price_adjustment_pct: adj});
    if (data.success) toast('Settings saved');
    else toast(data.error || 'Save failed', 'error');
  } catch (e) {
    toast('Save error: ' + e.message, 'error');
  }
}

async function saveEligibility() {
  const eligibility = {
    require_category: document.getElementById('elig-category').checked,
    require_quantity: document.getElementById('elig-quantity').checked,
    require_images: document.getElementById('elig-images').checked,
  };
  try {
    const data = await apiPost('/api/settings', { eligibility });
    if (data.success) {
      toast('Eligibility criteria saved');
    } else {
      toast(data.error || 'Save failed', 'error');
    }
  } catch (e) {
    toast('Save error: ' + e.message, 'error');
  }
}

document.getElementById('price-adj').addEventListener('input', updatePricePreview);
function updatePricePreview() {
  const adj = parseFloat(document.getElementById('price-adj').value) || 0;
  const base = 100;
  const adjusted = (base * (1 + adj / 100)).toFixed(2);
  document.getElementById('price-preview').innerHTML =
    `A $${base.toFixed(2)} Shopify price becomes <strong>$${adjusted}</strong> on Bluefly`;
}

// -----------------------------------------------------------------------
// Utility
// -----------------------------------------------------------------------
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// -----------------------------------------------------------------------
// Field Mapping Tab
// -----------------------------------------------------------------------
async function loadFieldMapping() {
  hideError('mapping-error');
  try {
    const data = await apiFetch('/api/field-mapping');
    if (data.error) throw new Error(data.error);

    const ptbody = document.getElementById('product-fields-tbody');
    ptbody.innerHTML = (data.product_fields || []).map(f => `<tr>
      <td><code>${esc(f.bluefly_field)}</code></td>
      <td><span class="badge badge-gray">${esc(f.source_type)}</span></td>
      <td style="font-size:12px;color:var(--text-muted)">${esc(f.shopify_source)}</td>
      <td>${f.default_value !== undefined ? `<code>${esc(String(f.default_value))}</code>` : ''}</td>
      <td>${esc(f.description)}</td>
      <td>${f.required ? '<span class="badge badge-error">Required</span>' : ''}</td>
    </tr>`).join('');

    const vtbody = document.getElementById('variant-fields-tbody');
    vtbody.innerHTML = (data.variant_fields || []).map(f => `<tr>
      <td><code>${esc(f.bluefly_field)}</code></td>
      <td><span class="badge badge-gray">${esc(f.source_type)}</span></td>
      <td style="font-size:12px;color:var(--text-muted)">${esc(f.shopify_source)}</td>
      <td>${f.default_value !== undefined ? `<code>${esc(String(f.default_value))}</code>` : ''}</td>
      <td>${esc(f.description)}</td>
      <td>${f.required ? '<span class="badge badge-error">Required</span>' : ''}</td>
    </tr>`).join('');

    const fd = data.field_defaults || {};
    setSelectVal('default-is-returnable', fd.is_returnable);
    setSelectVal('default-product-condition', fd.product_condition);
    setSelectVal('default-listing-status', fd.listing_status);
    setSelectVal('default-color-standard', fd.color_standard);

    loadFieldCatalog();
  } catch(e) {
    showError('mapping-error', e.message);
  }
}

function setSelectVal(id, val) {
  const el = document.getElementById(id);
  if (el && val !== undefined) el.value = val;
}

async function saveFieldDefaults() {
  const payload = {
    field_defaults: {
      is_returnable: document.getElementById('default-is-returnable').value,
      product_condition: document.getElementById('default-product-condition').value,
      listing_status: document.getElementById('default-listing-status').value,
      color_standard: document.getElementById('default-color-standard').value,
    }
  };
  try {
    const data = await apiPost('/api/settings', payload);
    if (data.error) throw new Error(data.error);
    toast('Field defaults saved');
  } catch(e) {
    showError('mapping-error', e.message);
  }
}

// -----------------------------------------------------------------------
// Bluefly Field Catalog
// -----------------------------------------------------------------------
let _catalogData = [];

async function loadFieldCatalog() {
  try {
    const data = await apiFetch('/api/bluefly/field-catalog');
    _catalogData = data.fields || [];
    renderCatalogTable();
  } catch(e) {
    showError('catalog-error', e.message);
    document.getElementById('catalog-error').style.display = '';
  }
}

function renderCatalogTable() {
  const search = (document.getElementById('catalog-search')?.value || '').toLowerCase();
  const catId  = (document.getElementById('catalog-category')?.value || '').trim();
  const level  = document.getElementById('catalog-level')?.value || '';
  const imp    = document.getElementById('catalog-importance')?.value || '';

  const rows = _catalogData.filter(f => {
    if (search && !f.field_name.toLowerCase().includes(search) &&
                  !f.display_name.toLowerCase().includes(search)) return false;
    if (catId && !f.target_ids.includes(catId)) return false;
    if (level && f.field_level !== level) return false;
    if (imp   && f.importance  !== imp)   return false;
    return true;
  });

  document.getElementById('catalog-count').textContent =
    `Showing ${rows.length} of ${_catalogData.length} fields`;

  document.getElementById('catalog-tbody').innerHTML = rows.map(f => {
    const vals    = f.allowed_values || [];
    const preview = vals.slice(0, 4).map(v => `<code style="font-size:11px">${esc(v)}</code>`).join(' ');
    const more    = vals.length > 4
      ? ` <span style="color:var(--text-muted);font-size:11px">+${vals.length - 4} more</span>`
      : '';
    const impBadge   = f.importance === 'Required'
      ? '<span class="badge badge-error">Required</span>'
      : '<span class="badge badge-gray">Conditional</span>';
    const levelBadge = f.field_level === 'Group'
      ? '<span class="badge badge-gray">Product</span>'
      : '<span class="badge badge-gray">Variant</span>';
    return `<tr>
      <td style="white-space:nowrap;font-size:12px;color:var(--text-muted)">${esc(f.category)} / ${esc(f.group)}</td>
      <td>${esc(f.display_name)}</td>
      <td><code>${esc(f.field_name)}</code></td>
      <td>${levelBadge}</td>
      <td>${impBadge}</td>
      <td><span class="badge badge-gray">${esc(f.data_type)}</span></td>
      <td style="max-width:280px">${preview}${more}</td>
      <td style="font-size:12px;color:var(--text-muted)">${esc(f.description)}</td>
    </tr>`;
  }).join('');
}

// -----------------------------------------------------------------------
// Init
// -----------------------------------------------------------------------
loadDashboard();
const today = new Date().toISOString().split('T')[0];
document.getElementById('event-date').value = today;
</script>
</body>
</html>
